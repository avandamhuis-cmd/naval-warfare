<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Box Battle Game with Swimming</title>
  <style>body{margin:0;overflow:hidden;}canvas{display:block;}</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);

// Ocean
const ocean = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshPhongMaterial({color:0x1E90FF,side:THREE.DoubleSide}));
ocean.rotation.x = -Math.PI/2;
scene.add(ocean);

// Island and dock
const island = new THREE.Mesh(new THREE.BoxGeometry(10,1,10), new THREE.MeshPhongMaterial({color:0x228B22}));
island.position.set(0,0.5,0); scene.add(island);

const dock = new THREE.Mesh(new THREE.BoxGeometry(4,0.2,2), new THREE.MeshPhongMaterial({color:0x8B4513}));
dock.position.set(-3,1.1,0); scene.add(dock);

// Boxes
function createBox(color,x,z){ const box=new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshPhongMaterial({color:color})); box.position.set(x,1,z); scene.add(box); return box; }
const player = createBox(0x0000ff,-3,0);
const enemy = createBox(0xff0000,20,0);

camera.position.set(0,15,20);
camera.lookAt(0,0,0);

// Movement
const keys={};
document.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// Musket equip/shoot
let musketEquipped=false;
document.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()==='e') musketEquipped=!musketEquipped;
  if(e.code==='Space' && musketEquipped) shootMusket();
});

// Player movement with swimming
function movePlayer(){
  // Check if player is in water
  const waterLevel = 0.5; // y-level of ocean surface
  const isSwimming = player.position.z > 5 || player.position.z < -5 || player.position.x > 5 || player.position.x < -5; // roughly outside island
  const speed = isSwimming ? 0.03 : 0.1; // slower in water

  if(keys['w']) player.position.z -= speed;
  if(keys['s']) player.position.z += speed;
  if(keys['a']) player.position.x -= speed;
  if(keys['d']) player.position.x += speed;
}

// Bullets + fire/smoke
const bullets = [];
const particles = [];

function shootMusket(){
  const bullet = new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8), new THREE.MeshPhongMaterial({color:0x000000}));
  bullet.position.set(player.position.x,1,player.position.z);
  bullet.direction = new THREE.Vector3(1,0,0);
  scene.add(bullet);
  bullets.push(bullet);

  // Fire effect
  for(let i=0;i<3;i++){
    const fire = new THREE.Mesh(new THREE.SphereGeometry(0.1,6,6), new THREE.MeshPhongMaterial({color:0xFFA500}));
    fire.position.set(player.position.x+0.5,1.1 + Math.random()*0.2,player.position.z + (Math.random()-0.5)*0.2);
    fire.life = 10 + Math.random()*5;
    scene.add(fire);
    particles.push(fire);
  }

  // Smoke
  const smoke = new THREE.Mesh(new THREE.SphereGeometry(0.2,6,6), new THREE.MeshPhongMaterial({color:0x888888, transparent:true, opacity:0.5}));
  smoke.position.set(player.position.x+0.5,1.2,player.position.z);
  smoke.life = 20;
  smoke.riseSpeed = 0.02;
  scene.add(smoke);
  particles.push(smoke);
}

// Update bullets and particles
function updateBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    bullets[i].position.addScaledVector(bullets[i].direction,0.3);
    if(Math.abs(bullets[i].position.x)>100 || Math.abs(bullets[i].position.z)>100){
      scene.remove(bullets[i]);
      bullets.splice(i,1);
    }
  }

  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.life--;
    if(p.material.opacity!==undefined) p.position.y += p.riseSpeed || 0;
    if(p.life<=0){ scene.remove(p); particles.splice(i,1); }
  }
}

// Animation loop
function animate(){
  requestAnimationFrame(animate);
  movePlayer();
  updateBullets();
  player.rotation.y += 0.01;
  enemy.rotation.y -= 0.01;
  renderer.render(scene,camera);
}
animate();

// Resize
window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
