<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Naval Game Prototype</title>
<style>
body { margin:0; overflow:hidden; }
canvas { display:block; }
#info { position:absolute; top:10px; left:10px; color:white; font-family:sans-serif;}
#crosshair {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:20px; color:white; user-select:none; pointer-events:none;}
#musketHUD { position:absolute; bottom:10px; left:10px; color:white; font-family:sans-serif; font-size:16px; }
#interactionText {position:absolute; color:white; font-family:sans-serif; font-size:16px; top:50%; left:50%; transform:translate(-50%,-50%); display:none;}
#market {position:absolute; width:300px; height:150px; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); color:white; display:none; padding:10px; font-family:sans-serif;}
#market button{margin-top:10px;}
</style>
</head>
<body>
<div id="info">Click to lock mouse. WASD move, SPACE jump/swim, Left Click fire, Right Click aim, R reload, 1 equip/unequip musket, E interact</div>
<div id="crosshair">+</div>
<div id="musketHUD"></div>
<div id="interactionText"></div>
<div id="market">
<h3>Market</h3>
<p>Buy Ship (50 gold)</p>
<button id="buyShip">Buy Ship</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script>
// --- Scene & Camera ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

// --- Player ---
const yawObject = new THREE.Object3D();
const pitchObject = new THREE.Object3D();
pitchObject.add(camera);
yawObject.add(pitchObject);
scene.add(yawObject);
yawObject.position.set(0,1.8,5);

// --- Lights ---
const sun = new THREE.DirectionalLight(0xffffff,1.2);
sun.position.set(50,100,50);
scene.add(sun);
scene.add(new THREE.AmbientLight(0xffffff,0.6));
scene.add(new THREE.HemisphereLight(0x87ceeb,0x228B22,0.4));

// --- Water ---
const waterGeometry = new THREE.PlaneGeometry(400,400,100,100);
const waterMaterial = new THREE.MeshLambertMaterial({color:0x1E90FF, side:THREE.DoubleSide});
const water = new THREE.Mesh(waterGeometry, waterMaterial);
water.rotation.x=-Math.PI/2; water.position.y=-2; scene.add(water);
const waterPositions = water.geometry.attributes.position;

// --- Collidables ---
const collidables = [];

// --- Island ---
const islandMaterial = new THREE.MeshLambertMaterial({color:0x228B22});
const islandShape = [
  {x:0, z:0, w:12, d:8, h:2},
  {x:-5, z:3, w:6, d:4, h:2},
  {x:4, z:-4, w:5, d:6, h:2},
  {x:2, z:6, w:4, d:3, h:2}
];
islandShape.forEach(p=>{
  const mesh = new THREE.Mesh(new THREE.BoxGeometry(p.w,p.h,p.d), islandMaterial);
  mesh.position.set(p.x,-1,p.z);
  scene.add(mesh); collidables.push(mesh);
});

// --- Dock ---
for(let i=-4;i<=4;i++){
  for(let j=0;j<3;j++){
    const plank=new THREE.Mesh(new THREE.BoxGeometry(1,0.3,2), new THREE.MeshLambertMaterial({color:0x8B4513}));
    plank.position.set(i*1.2,0,j*1.5-11); scene.add(plank); collidables.push(plank);
  }
}
for(let i=-4;i<=4;i++){
  for(let j=0;j<2;j++){
    const pillar=new THREE.Mesh(new THREE.BoxGeometry(0.3,2,0.3), new THREE.MeshLambertMaterial({color:0x654321}));
    pillar.position.set(i*1.2,-2+j*2,-11); scene.add(pillar); collidables.push(pillar);
  }
}

// --- Table + NPC ---
const table = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 1.5), new THREE.MeshLambertMaterial({color:0x8B4513}));
table.position.set(3,0,-6); scene.add(table); collidables.push(table);
const npc = new THREE.Mesh(new THREE.BoxGeometry(1,2.5,1), new THREE.MeshLambertMaterial({color:0x0000FF}));
npc.position.set(3,1.25,-7); scene.add(npc); collidables.push(npc);

// --- Interaction & Market ---
const interactionText = document.getElementById("interactionText");
const marketUI = document.getElementById("market");
const buyShipBtn = document.getElementById("buyShip");
let marketOpen=false;
let playerGold=100;

// --- Player movement ---
let player={height:1.8,speed:0.15,swimSpeed:0.07,jumpPower:0.25,yVelocity:0,isJumping:false,isSwimming:false};
let keys={};
document.addEventListener('keydown',e=>keys[e.code]=true);
document.addEventListener('keyup',e=>keys[e.code]=false);

// --- Mouse ---
let mouseLocked=false;
document.body.addEventListener("click",()=>{if(!mouseLocked)document.body.requestPointerLock();});
document.addEventListener("pointerlockchange",()=>{mouseLocked=(document.pointerLockElement===document.body);});
document.addEventListener("mousemove",e=>{
  if(mouseLocked){
    yawObject.rotation.y -= e.movementX*0.002;
    pitchObject.rotation.x -= e.movementY*0.002;
    pitchObject.rotation.x=Math.max(-Math.PI/2, Math.min(Math.PI/2, pitchObject.rotation.x));
  }
});

// --- Musket ---
let musketEquipped=true, ammo=1, isAiming=false, fireCooldown=false, isReloading=false;
const musket = new THREE.Object3D(); camera.add(musket);
const steelBarrel = new THREE.Mesh(new THREE.CylinderGeometry(0.008,0.008,1.2,16), new THREE.MeshLambertMaterial({color:0x444444}));
steelBarrel.rotation.x=Math.PI/2; steelBarrel.position.set(0,0,0.6); musket.add(steelBarrel);
const woodenStock = new THREE.Mesh(new THREE.CylinderGeometry(0.015,0.015,1.2,16), new THREE.MeshLambertMaterial({color:0x8B4513}));
woodenStock.rotation.x=Math.PI/2; woodenStock.position.set(0,-0.05,0.6); musket.add(woodenStock);
const muzzleFlash = new THREE.Mesh(new THREE.SphereGeometry(0.04,8,8), new THREE.MeshBasicMaterial({color:0xffaa00}));
muzzleFlash.visible=false; muzzleFlash.position.set(0,0,1.2); musket.add(muzzleFlash);
const smoke = new THREE.Mesh(new THREE.SphereGeometry(0.07,8,8), new THREE.MeshBasicMaterial({color:0x888888,transparent:true,opacity:0.5}));
smoke.visible=false; smoke.position.set(0,0,1.2); musket.add(smoke);
let bullets=[];
function spawnBullet(){
  const bullet = new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8), new THREE.MeshLambertMaterial({color:0x888888}));
  const tip = new THREE.Vector3();
  steelBarrel.getWorldPosition(tip);
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  bullet.position.copy(tip).add(dir.clone().multiplyScalar(0.1));
  bullet.userData = { velocity: dir.clone().multiplyScalar(1), spawnTime: performance.now(), damage:10 };
  scene.add(bullet); bullets.push(bullet);
}
function fireMusket(){ if(!musketEquipped||isReloading||fireCooldown||ammo<=0)return; ammo--; fireCooldown=true; muzzleFlash.visible=true; smoke.visible=true; smoke.material.opacity=0.5; setTimeout(()=>muzzleFlash.visible=false,150); spawnBullet(); setTimeout(()=>fireCooldown=false,300);}
function reloadMusket(){ if(!musketEquipped||isReloading||ammo===1)return; isReloading=true; setTimeout(()=>{ammo=1;isReloading=false;},7000);}
document.addEventListener("mousedown",e=>{if(e.button===0)fireMusket(); if(e.button===2)isAiming=true;});
document.addEventListener("mouseup",e=>{if(e.button===2)isAiming=false;});
document.addEventListener("contextmenu",e=>e.preventDefault());
document.addEventListener("keydown",e=>{if(e.code==="KeyR")reloadMusket(); if(e.code==="Digit1") musketEquipped=!musketEquipped;});

// --- HUD ---
const musketHUD = document.getElementById("musketHUD");
function updateHUD(){ musketHUD.innerHTML = musketEquipped ? `Ammo: ${ammo} ${isReloading?"(Reloading)":""} Gold:${playerGold}` : ""; }
// --- Ship System ---
let ships=[]; let currentShip=null;
function spawnShip(position){
  const shipMesh = new THREE.Mesh(new THREE.BoxGeometry(2,0.7,4), new THREE.MeshLambertMaterial({color:0x8B4513}));
  shipMesh.position.copy(position);
  shipMesh.position.y = water.position.y + 0.35; // float at water level
  scene.add(shipMesh);
  ships.push({mesh:shipMesh, speed:0, turn:0, health:100, sinking:false});
}

// --- Purchase Ship ---
buyShipBtn.onclick = ()=>{
  if(playerGold>=50){
    playerGold-=50;
    spawnShip(new THREE.Vector3(0,0,-14));
    marketUI.style.display="none"; marketOpen=false;
  } else alert("Not enough gold");
};

// --- Interaction & E key ---
let ePressed=false;
document.addEventListener("keydown",e=>{if(e.code==="KeyE") ePressed=true;});
document.addEventListener("keyup",e=>{if(e.code==="KeyE") ePressed=false;});

// --- Animate ---
function animate(){
  requestAnimationFrame(animate);
  const time=Date.now()*0.001;

  // Water waves
  for(let i=0;i<waterPositions.count;i++){
    const x=waterPositions.getX(i), y=waterPositions.getY(i);
    waterPositions.setZ(i, Math.sin(x*0.1+time)*0.15 + Math.cos(y*0.1+time)*0.15);
  }
  waterPositions.needsUpdate=true;

  // Player movement & swimming
  player.isSwimming = yawObject.position.y < water.position.y + 0.3 && currentShip===null;
  if(player.isSwimming){
    let dir = new THREE.Vector3();
    yawObject.getWorldDirection(dir); dir.y=0; dir.normalize();
    if(keys["KeyW"]) yawObject.position.add(dir.clone().multiplyScalar(player.swimSpeed));
    if(keys["KeyS"]) yawObject.position.add(dir.clone().multiplyScalar(-player.swimSpeed));
    if(keys["KeyA"]) yawObject.position.add(new THREE.Vector3().setFromMatrixColumn(yawObject.matrix,0).multiplyScalar(-player.swimSpeed));
    if(keys["KeyD"]) yawObject.position.add(new THREE.Vector3().setFromMatrixColumn(yawObject.matrix,0).multiplyScalar(player.swimSpeed));
    yawObject.position.y = water.position.y + 0.3 + Math.sin(time*4)*0.05;
    if(keys["Space"]) yawObject.position.y += 0.05;
  } else if(currentShip===null){
    let move=new THREE.Vector3();
    if(keys["KeyW"]) move.z-=1; if(keys["KeyS"]) move.z+=1;
    if(keys["KeyA"]) move.x-=1; if(keys["KeyD"]) move.x+=1;
    move.normalize();
    yawObject.translateX(move.x*player.speed);
    yawObject.translateZ(move.z*player.speed);
    if(yawObject.position.y>player.height) player.yVelocity-=0.015;
    else { yawObject.position.y=player.height; player.yVelocity=0; player.isJumping=false; }
    if(keys["Space"] && yawObject.position.y<=player.height+0.01){ player.yVelocity=player.jumpPower; player.isJumping=true; }
    yawObject.position.y += player.yVelocity;
  }

  // Ship steering
  if(currentShip!==null){
    const ship=currentShip;
    if(keys["KeyW"]) ship.speed+=0.02; else if(keys["KeyS"]) ship.speed-=0.02; else ship.speed*=0.9;
    if(keys["KeyA"]) ship.turn=0.03; else if(keys["KeyD"]) ship.turn=-0.03; else ship.turn*=0.9;
    ship.mesh.rotation.y+=ship.turn;
    const forward=new THREE.Vector3(0,0,1).applyEuler(new THREE.Euler(0,ship.mesh.rotation.y,0)).multiplyScalar(ship.speed);
    ship.mesh.position.add(forward);
    collidables.forEach(c=>{ if(ship.mesh.position.distanceTo(c.position)<2){ ship.mesh.position.sub(forward); ship.speed=0; } });
    yawObject.position.set(ship.mesh.position.x,ship.mesh.position.y+1.5,ship.mesh.position.z);
    camera.position.copy(yawObject.position);
  }

  // Musket aim
  let targetPos = musketEquipped ? (isAiming?new THREE.Vector3(0,-0.05,-0.6):new THREE.Vector3(0,-0.2,-0.8)) : new THREE.Vector3(0,0.5,0.3);
  musket.position.lerp(targetPos,0.1);
  if(smoke.visible){ smoke.material.opacity-=0.01; if(smoke.material.opacity<=0) smoke.visible=false; }

  // Bullets update & ship damage
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.position.add(b.userData.velocity.clone().multiplyScalar(0.5));
    let hit=false;
    collidables.forEach(c=>{ if(b.position.distanceTo(c.position)<1) hit=true; });
    ships.forEach(s=>{ if(b.position.distanceTo(s.mesh.position)<2){ s.health-=b.userData.damage; hit=true; } });
    if(hit || (performance.now()-b.userData.spawnTime>3000)){ scene.remove(b); bullets.splice(i,1); }
  }

  // Ship sinking
  ships.forEach(s=>{ if(s.health<=0 && !s.sinking){ s.sinking=true; s.speed=0; } if(s.sinking) s.mesh.position.y-=0.01; });

  // Interactions
  let interacted=false;
  const distNPC = yawObject.position.distanceTo(npc.position);
  if(distNPC<3 && currentShip===null){ 
    interactionText.style.display="block"; interactionText.innerText="Press E to open market"; interacted=true;
    if(ePressed && !marketOpen){ marketUI.style.display="block"; marketOpen=true; }
  }
  ships.forEach(ship=>{
    const dist = yawObject.position.distanceTo(ship.mesh.position);
    if(dist<4){
      interactionText.style.display="block"; 
      interactionText.innerText=currentShip===ship?"Press E to exit ship":"Press E to board ship"; 
      interacted=true;
      if(ePressed && currentShip!==ship) currentShip=ship;
      else if(ePressed && currentShip===ship) currentShip=null;
    }
  });
  if(!interacted){ interactionText.style.display="none"; marketUI.style.display="none"; marketOpen=false; }

  // HUD
  updateHUD();
  renderer.render(scene,camera);
}
animate();

// --- Resize ---
window.addEventListener("resize",()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
